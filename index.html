<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‚ö° 4HM Jank-O-Meter ‚ö°</title>
  <meta name="robots" content="index,follow">
  <meta name="copyright" content="¬© TC Games, LLC (Travis Smith) 2025">
  
  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  
  <style>
    body { font-family: "Book Antiqua", Palatino, serif; background:#fdf6e3; color:#2b1a08; }
    header { text-align:center; padding: 10px; }
    .panel { background:#f9f2dd; border:2px solid #c8a96c; border-radius:16px; padding:14px; margin:12px auto; max-width:1100px; }
    table.dataTable { background:#fdf6e3; border:2px solid #d6b87a; border-radius:12px; }
    table.dataTable thead th { background:#f2e6c6; color:#3a240a; font-weight:bold; }
    .score-badge { background:#f2e6c6; border:1px solid #c8a96c; padding:10px; border-radius:12px; margin:6px 0; }
    .tag { display:inline-block; padding:2px 6px; border-radius:999px; border:1px solid #c8a96c; background:#fff9e6; margin-left:6px; font-size:12px; color:#5a3816; }
    .tag.banned { border-color:#b66; background:#fde9e9; color:#8b1a1a; }
    .tag.restricted { border-color:#b88; background:#fbeff8; color:#8b4513; }
  </style>
</head>
<body>
  <header>
    <h1>‚ö° 4HM Jank-O-Meter ‚ö°</h1>
    <div class="sub">Filter rarely-played cards, score your deck‚Äôs Jank, and validate 4HM legality with the current rules.</div>
  </header>

  <div class="wrap">
    <div class="panel" id="scorePanel">
      <h2>üß™ Jank Score + ‚úÖ Deck Validator</h2>
      <textarea id="deckInput" placeholder="Paste your decklist here..."></textarea>
      <div>
        <input type="file" id="deckFile" accept=".txt,.dek,.dec"/>
        <button id="analyzeBtn">Analyze &amp; Validate Deck</button>
        <label><input type="checkbox" id="includeSb"/> Include sideboard in scores</label>
      </div>
      <div class="score-badge">
        <b>Jank Score:</b> <span id="scoreValue">‚Äî</span>/100
        <div id="scoreFlavor"></div>
      </div>
      <div class="score-badge">
        <b>Top 10 Jankiest</b>
        <ol id="topJank"></ol>
      </div>
      <div class="score-badge">
        <b>Validation</b>
        <div id="valStatus"></div>
        <ul id="valErrors"></ul>
      </div>
    </div>

    <div class="panel">
      <div class="table-wrap">
        <table id="jankTable" class="display">
          <thead>
            <tr>
              <th>Set</th>
              <th>Card</th>
              <th>Main Deck</th>
              <th>Sideboard</th>
              <th>Total</th>
              <th>Jank Pts (per copy)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" id="lastUpdated">‚è±Ô∏è <b>Last updated:</b> ‚Ä¶</div>
    </div>
  </div>

<script>
// === CONFIG ===
const BASICS = new Set(["plains","island","swamp","mountain","forest"]);
const DUALS = new Set([
  "badlands","bayou","plateau","savannah","scrubland",
  "taiga","tropicalisland","tundra","undergroundsea","volcanicisland"
]);

function normName(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]/g,''); }

// === Helpers ===
function isBasicOrDual(key){ return BASICS.has(key) || DUALS.has(key); }
function isStaple(total){ return total >= 350; }

function jankWeight(total, key){
  if (isBasicOrDual(key) || isStaple(total)) return 0;
  const logMax = Math.log(1000+1); // scale reference
  return Math.round(100 * (1 - (Math.log((total||0)+1)/logMax)));
}

function parseDeck(text){
  const lines = text.split(/\r?\n/);
  const main = new Map(); const side = new Map();
  let toSide=false;
  for(const raw of lines){
    const line=raw.trim(); if(!line) continue;
    if(/^side/i.test(line)){ toSide=true; continue; }
    const m=line.match(/^(\d+)?\s*(.+)$/);
    if(!m) continue;
    const n=m[1]?parseInt(m[1],10):1;
    const key=normName(m[2]);
    (toSide?side:main).set(key,(toSide?side:main).get(key)||0+n);
  }
  return {main,side};
}

function scoreDeck(parsed, includeSide){
  // NOTE: Replace stub data with real allRows map if available.
  const allCards=[...parsed.main.entries()].map(([k,c])=>({key:k,count:c,total:Math.floor(Math.random()*400)}));
  const sideCards=[...parsed.side.entries()].map(([k,c])=>({key:k,count:c,total:Math.floor(Math.random()*400)}));

  const pool=[...allCards, ...(includeSide?sideCards:[])];
  const numerator=pool.reduce((a,x)=>a+x.count*jankWeight(x.total,x.key),0);
  const nonStapleNonLand=pool.filter(x=>!isBasicOrDual(x.key)&&!isStaple(x.total));
  const denom=nonStapleNonLand.reduce((a,x)=>a+x.count,0)*100 || 1;
  let baseScore=(numerator/denom)*100;

  const copiesMain=allCards.reduce((a,x)=>a+x.count,0);
  const over60=Math.max(0,copiesMain-60);
  const finalScore=Math.min(100,Math.round(baseScore+over60*0.25));

  return {score:finalScore, top:pool.sort((a,b)=>jankWeight(b.total,b.key)-jankWeight(a.total,a.key)).slice(0,10)};
}

function render(deck){
  const parsed=parseDeck(deck);
  const includeSb=document.getElementById('includeSb').checked;
  const res=scoreDeck(parsed,includeSb);
  document.getElementById('scoreValue').textContent=res.score;
  document.getElementById('scoreFlavor').textContent = res.score>=70?"Spice bomb!":"Could use more jank.";
  const list=document.getElementById('topJank'); list.innerHTML='';
  res.top.forEach(t=>{const li=document.createElement('li');li.textContent=`${t.key} (${jankWeight(t.total,t.key)===0?0:jankWeight(t.total,t.key)})`;list.appendChild(li);});
}

document.getElementById('analyzeBtn').addEventListener('click',()=>{
  const txt=document.getElementById('deckInput').value;
  if(!txt.trim()){alert('Paste a decklist first.');return;}
  render(txt);
});

function exportCSV(){
  const rows = jQuery('#jankTable').DataTable().rows().data().toArray();
  const header = ['Set','Card','Main Deck','Sideboard','Total','Jank Pts (per copy)'];
  const lines = [header.join(',')].concat(rows.map(r => r.join(',')));
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `4HM-jank-export.csv`;
  a.click();
}
</script>

</body>
</html>
