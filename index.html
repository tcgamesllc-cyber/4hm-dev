<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>⚡ 4HM Jank‑O‑Meter ⚡</title>
  <meta name="robots" content="index,follow">
  <meta name="copyright" content="© TC Games, LLC (Travis Smith) 2025">

  <!-- libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <style>
    /* (same CSS as stable build, unchanged) */
  </style>
</head>
<body>
  <!-- (same HTML structure as stable build, unchanged) -->

  <script>
    // === CONFIG ===
    const CARDPOOL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTbTvT5tNT1w_Nqz1dL-t3muSuqzQ8UkO9ssHNZT1koEM8iVQQuY7QwGpTImtqv58zT837gLm8GZG84/pub?output=csv";
    const BR_URL       = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP2NPEcvsNl4wkBSKApw-opRIZ-C3rwFj51wJbMh1wYm_ci8y7o46gyfSubTbsfApvpoJpS2ysRohD/pub?output=csv";

    // === GLOBAL STATE ===
    let allRows = [];
    let dataTable = null;
    let MAX_TOTAL = 1;

    let LEGAL_CARDS = new Map();
    let NAME_MAP = new Map();
    let BANNED = new Set();
    let RESTRICTED = new Set();
    const BASIC_SET = new Set(["plains","island","swamp","mountain","forest"]);
    const DUAL_SET = new Set(["badlands","bayou","plateau","savannah","scrubland","taiga","tropicalisland","tundra","undergroundsea","volcanicisland"]);
    function isDual(key){ return DUAL_SET.has(key); }
    function isStaple(total){ return total >= 350; }
    function jankWeight(t, key){
      if (BASIC_SET.has(key) || isDual(key) || isStaple(t)) return 0;
      const logMax = Math.log(Math.max(1,MAX_TOTAL)+1);
      return Math.round(100 * (1 - (Math.log((t||0)+1)/logMax)));
    }

    const HARD_BANNED = new Set(["bloodmoon","karakas","arenaoftheancients","bronzetablet","cityinabottle","golgothiansylex","jeweledbird","libraryofalexandria","moat","rebirth","shahrazad","tempestefreet"]);
    let LEG6PLUS = new Set();
    let LEG5 = new Set();

    // (all other global vars unchanged)

    // === (utility + ingest functions unchanged, except they use new jankWeight) ===

    function scoreDeck(parsed, includeSide){
      const toRow = new Map(); const nameMap = new Map();
      for(const r of allRows){ const k = normName(r.card); if(!nameMap.has(k)) nameMap.set(k, r.card); if(!toRow.has(k)) toRow.set(k, r); }
      function mapToArr(m){ return Array.from(m.entries()).map(([key,count])=>({key, count})); }
      const mainArr = mapToArr(parsed.main); const sideArr = mapToArr(parsed.side);

      const matchedMain = []; const matchedSide = []; const unmatched = [];
      for(const item of mainArr){ const row = toRow.get(item.key); if(!row){ unmatched.push(`Main: ${item.count} × ${item.key}`); continue; } matchedMain.push({ key:item.key, official: nameMap.get(item.key)||item.key, total: Number(row.total)||0, count: item.count }); }
      for(const item of sideArr){ const row = toRow.get(item.key); if(!row){ unmatched.push(`Side: ${item.count} × ${item.key}`); continue; } matchedSide.push({ key:item.key, official: nameMap.get(item.key)||item.key, total: Number(row.total)||0, count: item.count }); }

      // Numerator
      const weight = (t,key) => jankWeight(t,key);
      let copiesMain = 0, raw = 0; for (const m of matchedMain){ copiesMain += m.count; raw += m.count * weight(m.total,m.key); }
      let rawSide = 0; if (includeSide){ for (const s of matchedSide){ rawSide += s.count * weight(s.total,s.key); } }

      // Denominator based on non-staple, non-land pool (main+side if included)
      const pool = [...matchedMain, ...(includeSide?matchedSide:[])];
      const nonStapleNonLand = pool.filter(x => !(BASIC_SET.has(x.key) || isDual(x.key)) && !isStaple(x.total));
      const rawMax = nonStapleNonLand.reduce((a,b)=>a+b.count,0) * 100 || 1;

      const baseScore = Math.max(0, Math.min(100, ((raw + rawSide) / rawMax) * 100));
      const deepCopies = matchedMain.filter(x => x.total <= 20).reduce((a,b)=> a + b.count, 0);
      const deepDensity = copiesMain ? Math.round(100 * deepCopies / copiesMain) : 0;
      const bonus = Math.round(25 * Math.pow(deepDensity / 100, 1.1));
      const over60 = Math.max(0, copiesMain - 60);
      const over60Bonus = over60 * 0.25;
      const finalScore = Math.max(0, Math.min(100, baseScore + bonus + over60Bonus));

      const allForTop = [...matchedMain].map(x => ({key:x.key, name:x.official, w: weight(x.total,x.key), total:x.total, count:x.count}));
      allForTop.sort((a,b)=> b.w - a.w);
      const top10 = allForTop.slice(0,10);

      // Tier counts unchanged

      return { score: Math.round(finalScore), baseScore: Math.round(baseScore), bonus, deepDensity, top10, tierCounts:{}, copiesMain, over60, over60Bonus };
    }

    function renderTable(threshold, setFilter){
      const rows = allRows.filter(r => r.total <= threshold && (!setFilter || r.set === setFilter) && passesColorFilter(r) && passesTypeFilter(r) && passesSuperFilter(r) && passesRarityFilter(r) && passesManaFilter(r) && passesNameSearch(r));
      rows.forEach(r => { r.jankValue = jankWeight(r.total,r.key)===0 ? 0 : Number((jankWeight(r.total,r.key)/60).toFixed(2)); });
      const data = rows.map(r => {
        const isBan = BANNED.has(r.key) || HARD_BANNED.has(r.key);
        const isRes = RESTRICTED.has(r.key);
        const tags = `${isBan?'<span class="tag banned">BANNED</span>':''}${(!isBan && isRes)?'<span class="tag restricted">Restricted</span>':''}`;
        const link = `<a href=\"#\" class=\"cardlink\" data-key=\"${r.key}\">${r.card}</a>${tags}`;
        return [r.set, link, r.main, r.side, r.total, r.jankValue===0?"0":r.jankValue];
      });
      if(dataTable){ dataTable.clear().rows.add(data).order([[4,'desc'],[0,'asc'],[1,'asc']]).draw(); bindRowClicks(); }
      else {
        dataTable = jQuery('#jankTable').DataTable({ data, columns: [ { title: 'Set' }, { title: 'Card' }, { title: 'Main Deck' }, { title: 'Sideboard' }, { title: 'Total' }, { title: 'Jank Pts (per copy)' } ], order: [[4, 'desc'], [0, 'asc'], [1, 'asc']], pageLength: 25, deferRender: true, dom: 'tip' });
        bindRowClicks();
      }
    }

    function exportCSV(){
      const v = Number(document.getElementById('thresholdNumber').value);
      const set = document.getElementById('setFilter').value || '';
      const rows = allRows.filter(r => r.total <= v && (!set || r.set === set) && passesColorFilter(r) && passesTypeFilter(r) && passesSuperFilter(r) && passesRarityFilter(r) && passesManaFilter(r) && passesNameSearch(r));
      const header = ['Set','Card','Main Deck','Sideboard','Total','Jank Pts (per copy)'];
      const lines = [header.join(',')].concat(rows.map(r => [r.set, r.card, r.main, r.side, r.total, jankWeight(r.total,r.key)===0?"0":(jankWeight(r.total,r.key)/60).toFixed(2)].join(',')));
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `4HM-jank-threshold-${v}.csv`;
      a.click();
    }

    // (rest of script unchanged)
  </script>
</body>
</html>
